<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

	<!-- http://www.liquibase.org/documentation/changes/index.html -->

	<changeSet id="munsell-01" author="abrin">
		<update tableName="information_resource_file">
			<column name="restriction" value="EMBARGOED_FIVE_YEARS" />
			<where>restriction='EMBARGOED'</where>
		</update>
	</changeSet>

	<changeSet id="munsell-02" author='jtdevos'>
		<dropColumn tableName="institution" columnName="email" />
		<addColumn tableName="institution">
			<column name="email" type="varchar(255)" />
		</addColumn>
		<addUniqueConstraint columnNames="email"
			constraintName="uk_9grdn54hea5ns8ahq4yogpb7u" deferrable="false"
			disabled="false" initiallyDeferred="false" tableName="institution" />
	</changeSet>

	<changeSet id="munsell-03" author="abrin">

		<addColumn tableName="resource_access_day_agg">
			<column name="month" type="INT4" />
		</addColumn>
		<addColumn tableName="file_download_day_agg">
			<column name="month" type="INT4" />
		</addColumn>
		<createIndex indexName="agg_res_month" tableName="resource_access_day_agg"
			unique="false">
			<column name="month" />
		</createIndex>
		<createIndex indexName="agg_dwnld_month" tableName="file_download_day_agg"
			unique="false">
			<column name="month" />
		</createIndex>
		<createIndex indexName="agg_res_month_year" tableName="resource_access_day_agg"
			unique="false">
			<column name="year" />
			<column name="month" />
		</createIndex>
		<createIndex indexName="agg_dwnld_month_year" tableName="file_download_day_agg"
			unique="false">
			<column name="year" />
			<column name="month" />
		</createIndex>

		<update tableName="resource_access_day_agg">
			<column name="month" valueNumeric="date_part('month',date_accessed)" />
		</update>
		<update tableName="file_download_day_agg">
			<column name="month" valueNumeric="date_part('month',date_accessed)" />
		</update>
	</changeSet>
	<changeSet id="munsell-04" author="abrin">
		<comment>Changing database to match hibernate validation requirements</comment>
		<modifyDataType tableName="coding_sheet" columnName="category_variable_id"
			newDataType="int8" />
		<modifyDataType tableName="ontology" columnName="category_variable_id"
			newDataType="int8" />
		<modifyDataType tableName="data_table_column"
			columnName="category_variable_id" newDataType="int8" />
		<modifyDataType tableName="category_variable_synonyms"
			columnName="categoryvariable_id" newDataType="int8" />
		<modifyDataType tableName="resource_collection_view_statistics"
			columnName="date_accessed" newDataType="date" />
		<modifyDataType tableName="creator_view_statistics"
			columnName="date_accessed" newDataType="date" />
		<modifyDataType tableName="resource_access_statistics"
			columnName="date_accessed" newDataType="date" />
		<modifyDataType tableName="information_resource_file_download_statistics"
			columnName="date_accessed" newDataType="date" />
		<modifyDataType tableName="information_resource_file"
			columnName="number_of_parts" newDataType="int4" />
		<modifyDataType tableName="information_resource_file"
			columnName="file_created_date" newDataType="date" />
		<modifyDataType tableName="source_collection"
			columnName="text" newDataType="text" />
		<modifyDataType tableName="stats" columnName="recorded_date"
			newDataType="date" />
		<modifyDataType tableName="related_comparative_collection"
			columnName="text" newDataType="text" />
		<modifyDataType tableName="sensory_data_image"
			columnName="sequence_number" newDataType="int4" />
		<modifyDataType tableName="sensory_data_scan"
			columnName="sequence_number" newDataType="int4" />
		<!-- <modifyDataType tableName="sensory_data_scan" columnName="resolution" 
			newDataType="float8" /> -->
	</changeSet>
	<changeSet id="munsell-05" author="abrin">
		<addColumn tableName="creator">
			<column name="browse_occurrence" defaultValue="0" type="int8"></column>
			<column name="hidden" defaultValue="false" type="boolean"></column>
		</addColumn>
	</changeSet>


	<changeSet id="munsell-06" author="jdevos">
		<createTable tableName="download_authorization">
			<column name="id" autoIncrement="true" type="bigint">
				<constraints nullable="false" primaryKey="true" />
			</column>
			<column name="resource_collection_id" type="bigint">
				<constraints nullable="false" references="collection"
					foreignKeyName="fk_download_authorization__resource_collection_id__collection" />
			</column>
			<column name="institution_id" type="bigint">
				<constraints nullable="false" references="institution"
					foreignKeyName="fk_download_authorization__institution_id__institution" />
			</column>
			<column name="api_key" type="varchar(50)">
				<constraints nullable="false" />
			</column>
			<column name="referer_regex" type="varchar(50)">
				<constraints nullable="false" />
			</column>
		</createTable>
		<rollback>
			<dropTable tableName="download_authorization" />
		</rollback>
	</changeSet>
	<changeSet id="munsell-07" author="abrin">
		<addColumn tableName="collection">
			<column name="hidden" type="boolean" defaultValueBoolean="false" />
		</addColumn>
		<update tableName="collection">
			<column name="hidden" valueBoolean="TRUE" />
			<where>visible is false</where>
		</update>
	</changeSet>
	<changeSet id="munsell-09" author="abrin">
		<dropColumn tableName="collection" columnName="visible" />
	</changeSet>
	<changeSet id="munsell-08-ab" author="abrin">
		<comment>Changing database to match hibernate validation requirements</comment>
		<modifyDataType tableName="resource_collection_view_statistics"
			columnName="date_accessed" newDataType="timestamp" />
		<modifyDataType tableName="creator_view_statistics"
			columnName="date_accessed" newDataType="timestamp" />
		<modifyDataType tableName="resource_access_statistics"
			columnName="date_accessed" newDataType="timestamp" />
		<modifyDataType tableName="information_resource_file_download_statistics"
			columnName="date_accessed" newDataType="timestamp" />
		<modifyDataType tableName="information_resource_file"
			columnName="file_created_date" newDataType="date" />
		<modifyDataType tableName="sensory_data_scan"
			columnName="resolution" newDataType="varchar(255)" />
	</changeSet>

	<changeSet id="munsell-10" author="abrin">
		<dropColumn tableName="download_authorization" columnName="referer_regex" />
		<dropColumn tableName="download_authorization" columnName="institution_id" />
		<createTable tableName="referrer_hostnames">
			<column name="download_authorization_id" type="bigint">
				<constraints nullable="false" references="download_authorization"
					foreignKeyName="fk_referrer_hostnames__download_authorization_id" />
			</column>
			<column name="hostname" type="varchar(255)" />
		</createTable>
	</changeSet>
	
	<changeSet id="munsell-11" author="abrin">
		<comment>adding authorization table for users to manage institutions</comment>
		<createTable tableName="institution_authorization">
			<column name="id" type="bigserial" />
			<column name="user_id" type="bigint">
				<constraints nullable="false" references="tdar_user"
					foreignKeyName="fk_institution_authorization__tdar_user_id" />
			</column>
			<column name="institution_id" type="bigint">
				<constraints nullable="false" references="institution"
					foreignKeyName="fk_institution_authorization__institution_id" />
			</column>
			<column name="authorized" type="boolean" defaultValueBoolean="false" />
			<column name="reason" type="text" />
		</createTable>

	</changeSet>

	<changeSet id="munsell-004766b0e703-feature-integration-ko" author="jdevos">
		<comment>adding top-level table for persisted workflow integrations</comment>
		<createTable tableName="data_integration_workflow">
			<column name="id" type="bigserial" />
			<column name="user_id" type="bigint" >
			<!-- TODO: proposal: put fk names in form of fk_sourcetable__sourcecolumn__destinationtable instead of fk_sourcetable__destinationtable__destinationcolumn -->
			<constraints nullable="false" references="tdar_user"
						 foreignKeyName="fk_data_integration_workflow__tdar_user_id" />
			</column>
			<column name="title" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="varchar(2047)" defaultValue="" />
			<column name="json_data" type="clob" />
		</createTable>
	</changeSet>

</databaseChangeLog>
