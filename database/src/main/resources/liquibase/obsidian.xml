<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">


    <!-- http://www.liquibase.org/documentation/changes/index.html -->

    <changeSet id="obsidian-1" author="abrin" failOnError="false">
        <dropColumn tableName="institution" columnName="merge_creator_id" />
        <dropColumn tableName="person" columnName="merge_creator_id" />
    </changeSet>

    <changeSet id="obsidian-2" author="abrin">
        <addPrimaryKey tableName="data_integration_workflow" columnNames="id"/>
        <createTable tableName="data_integration_users">
            <column name="id" type="bigserial" />
            <column name="user_id" type="bigint">
                <constraints nullable="false" references="tdar_user"
                    foreignKeyName="fk_integration_authorization__tdar_user_id" />
            </column>
            <column name="integration_id" type="bigint">
                <constraints nullable="false"
                    references="data_integration_workflow"
                    foreignKeyName="fk_integration_authorization___id" />
            </column>
        </createTable>
        <addColumn tableName="data_integration_workflow">
            <column name="hidden" defaultValueBoolean="false" type="boolean"/>
        </addColumn>
    </changeSet>
    
    <changeSet id="obsidian-3" author="abrin">
        <addColumn tableName="email_queue">
            <column name="resource_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint constraintName="fk_email_resource_id" referencedTableName="resource" baseColumnNames="resource_id" baseTableName="email_queue" referencedColumnNames="id" />        
        <addColumn tableName="email_queue">
            <column name="message_type" type="varchar(50)" />
        </addColumn>
    </changeSet>
    <changeSet id="obsidian-4" author="abrin">
        <addColumn tableName="resource_revision_log">
            <column name="revision_type" type="varchar(50)" />
            <column name="time_seconds" type="bigint" />
        </addColumn>
    </changeSet>

    <changeSet id="obsidian-5" author="abrin">
        <update tableName="data_integration_workflow">
        <column name="hidden" valueBoolean="true"/></update>
    </changeSet>
    
    <changeSet id="obsidian-6" author="abrin">
    <comment>setting up resource revision log (type) based on unique keys/values</comment>    
    <sql>
        update  resource_revision_log set revision_type='DELETE' where log_message ilike '%deleted by%';
        update  resource_revision_log set revision_type='EDIT' where log_message ilike '%edited and saved%';
        update  resource_revision_log set revision_type='CREATE' where log_message ilike '%created\:%';
        update  resource_revision_log set revision_type='EDIT' where log_message ilike 'updated:%';
        update  resource_revision_log set revision_type='CREATE' where log_message ilike 'clone%';
        update  resource_revision_log set revision_type='EDIT' where log_message ilike '%genearting%';
    </sql>
    </changeSet>
    <changeSet id="obsidian-7" author="abrin">
        <addColumn tableName="keyword_mapping">
            <column name="label" type="varchar(255)" />
        </addColumn>
    </changeSet>
    <changeSet id="obsidian-8" author="abrin">
        <addColumn tableName="tdar_user">
            <column name="user_agent" type="varchar(512)" />
        </addColumn>
    </changeSet>
    <changeSet id="obsidian9" author="abrin">
        <createIndex tableName="culture_keyword" indexName="idx_culture_keyword_synonym">
            <column name="merge_keyword_id" />
            <column name="id" />
        </createIndex>
        <createIndex tableName="geographic_keyword" indexName="idx_geographic_keyword_synonym">
            <column name="merge_keyword_id" />
            <column name="id" />
        </createIndex>
        <createIndex tableName="material_keyword" indexName="idx_material_keyword_synonym">
            <column name="merge_keyword_id" />
            <column name="id" />
        </createIndex>
        <createIndex tableName="site_name_keyword" indexName="idx_site_name_keyword_synonym">
            <column name="merge_keyword_id" />
            <column name="id" />
        </createIndex>
        <createIndex tableName="site_type_keyword" indexName="idx_site_type_keyword_synonym">
            <column name="merge_keyword_id" />
            <column name="id" />
        </createIndex>
        <createIndex tableName="temporal_keyword" indexName="idx_temporal_keyword_synonym">
            <column name="merge_keyword_id" />
            <column name="id" />
        </createIndex>
        <createIndex tableName="investigation_type" indexName="idx_investigation_type_keyword_synonym">
            <column name="merge_keyword_id" />
            <column name="id" />
        </createIndex>
        <createIndex tableName="other_keyword" indexName="idx_other_keyword_synonym">
            <column name="merge_keyword_id" />
            <column name="id" />
        </createIndex>
    </changeSet>
    <changeSet id="obsidian-9" author="abrin">
        <modifyDataType tableName="geographic_keyword" columnName="code" newDataType="varchar(10)"/>
    </changeSet>
    <changeSet id="obsidian-10" author="abrin">
        <addColumn tableName="information_resource_file">
            <column name="preservation_note" type="text" />
            <column name="preservation_status" type="varchar(255)" />
        </addColumn>
    </changeSet>

    <changeSet id="obsidian-11" author="abrin">
    <createTable tableName="collection_revision_log">
        <column name="id" type="bigserial" />
        <column name="revision_type" type="varchar(25)" />
        <column name="log_message" type="varchar(512)" />
        <column name="time_seconds" type="bigint" />
        <column name="person_id" type="bigint">
            <constraints nullable="false" references="tdar_user"
                foreignKeyName="fk_collection_revision__tdar_user_id" />
        </column>
        <column name="collection_id" type="bigint">
            <constraints nullable="true" references="collection"
                foreignKeyName="fk_collection_revision__collection_id" />
        </column>
    </createTable>
    </changeSet>
    <changeSet id="obsidian-12" author="abrin">
        <addColumn tableName="collection_revision_log">
            <column name="timestamp" type="timestamp" />
        </addColumn>
    </changeSet>
    
    <changeSet id="obsidian-13" author="abrin">
    <dropForeignKeyConstraint baseTableName="collection_revision_log" constraintName="fk_collection_revision__collection_id"/>
    </changeSet>

    <changeSet id="obsidian-14" author="abrin">
    	<addColumn tableName="collection">
    		<column name="system_managed" type="boolean" defaultValueBoolean="false" />
   		</addColumn>
    </changeSet>
    
    <changeSet id="obsidian-15" author="abrin">
        <renameColumn tableName="resource_culture_keyword" oldColumnName="culture_keyword_id" newColumnName="keyword_id"/>
        <renameColumn tableName="resource_site_name_keyword" oldColumnName="site_name_keyword_id" newColumnName="keyword_id"/>
        <renameColumn tableName="resource_site_type_keyword" oldColumnName="site_type_keyword_id" newColumnName="keyword_id"/>
        <renameColumn tableName="resource_temporal_keyword" oldColumnName="temporal_keyword_id" newColumnName="keyword_id"/>
        <renameColumn tableName="resource_other_keyword" oldColumnName="other_keyword_id" newColumnName="keyword_id"/>
        <renameColumn tableName="resource_geographic_keyword" oldColumnName="geographic_keyword_id" newColumnName="keyword_id"/>
        <renameColumn tableName="resource_managed_geographic_keyword" oldColumnName="geographic_keyword_id" newColumnName="keyword_id"/>
        <renameColumn tableName="resource_investigation_type" oldColumnName="investigation_type_id" newColumnName="keyword_id"/>
        <renameColumn tableName="resource_material_keyword" oldColumnName="material_keyword_id" newColumnName="keyword_id"/>
    </changeSet>
        
    
    <changeSet id="obsidian-16" author="abrin">
        <createTable tableName="dataone_object">
        <column name="id" type="bigserial" />
        <column name="identifier" type="varchar(100)" />
        <column name="series_id" type="varchar(100)" />
        <column name="entry_type" type="varchar(100)" />
        <column name="format_id" type="varchar(255)" />
        <column name="submitter" type="varchar(512)" />
        <column name="obsoletes" type="varchar(100)" />
        <column name="obsoleted_by" type="varchar(100)" />
        <column name="checksum" type="varchar(255)" />
        <column name="size" type="bigint" />
        <column name="tdar_id" type="bigint" />
        <column name="sys_metadata_modified" type="timestamp" />
        <column name="date_created" type="timestamp" />
    </createTable>
        </changeSet>
    
    <changeSet id="obsidian-17" author="abrin">
	    <addColumn tableName="dataone_object">
	        <column name="date_uploaded" type="timestamp" />
	    </addColumn>
    
    </changeSet>
    <changeSet id="obsidian-18" author="abrin">
    <createTable tableName="collection_request">
        <column name="id" type="bigserial" />
        <column name="general_permission" type="varchar(50)"/>
        <column name="name" type="varchar(500)"/>
        <column name="description_request" type="varchar(500)" />
        <column name="description_response" type="varchar(500)" />
        <column name="contact_id" type="bigint" />
    </createTable>
    <createTable tableName="collection_request_collection_ids">
        <column name="collection_request_id" type="bigint" />
        <column name="collection_id" type="bigint" />
        <column name="collections_id" type="bigint" />
    </createTable>
    <addPrimaryKey tableName="collection_request" columnNames="id"/>
    <addForeignKeyConstraint constraintName="collection_request_user_id" 
        referencedTableName="tdar_user" 
        baseColumnNames="contact_id" baseTableName="collection_request" referencedColumnNames="id"/>
    <addForeignKeyConstraint constraintName="collection_request_collection_id" 
        referencedTableName="collection" 
        baseColumnNames="collection_id" baseTableName="collection_request_collection_ids" referencedColumnNames="id"/>
    </changeSet>
    <changeSet id="obsidian-19" author="abrin">
        <sql>update email_queue set message_type ='CUSTOM' where message_type='SAA';</sql>
    </changeSet>
    <changeSet id="obsidian-20" author="abrin">
    <addColumn tableName="resource_access_statistics">
        <column name="bot" type="boolean" defaultValueBoolean="false" />
    </addColumn>
    <addColumn tableName="creator_view_statistics">
        <column name="bot" type="boolean" defaultValueBoolean="false" />
    </addColumn>

    <addColumn tableName="resource_collection_view_statistics">
        <column name="bot" type="boolean" defaultValueBoolean="false" />
    </addColumn>
    <addColumn tableName="resource_access_day_agg">
        <column name="bot" type="boolean" defaultValueBoolean="false" />
    </addColumn>
    
    </changeSet>
    <changeSet id="obsidian-21" author="abrin">
        <addColumn tableName="information_resource_file_download_statistics">
            <column name="bot" type="boolean" defaultValueBoolean="false" />
        </addColumn>
    </changeSet>
    <changeSet id="obsidian-22" author="abrin">
    <dropColumn tableName="resource_access_day_agg" columnName="bot"/>
        <addColumn tableName="resource_access_day_agg">
            <column name="bot" type="bigint" />
        </addColumn>
    </changeSet>
    <changeSet id="obsidian-23" author="abrin">
        <addColumn tableName="collection">
            <column name="alternate_parent_id" type='bigint' />
        </addColumn>
        <addForeignKeyConstraint constraintName="collection_alternate_parent_id" 
            referencedTableName="collection" 
            baseColumnNames="alternate_parent_id" baseTableName="collection" referencedColumnNames="id"/>
    </changeSet>
    <changeSet id="obsidian-24" author="abrin">
        <createIndex tableName="resource" indexName="resource_updated_status_id">
            <column name="date_updated"/>
            <column name="status"/>
            <column name="id"/>
        </createIndex>
    </changeSet>
    <changeSet id="obsidian-stats-1" author="abrin">
        <sql>create table resource_access_day_agg_2 (id bigserial, resource_id bigint, date_accessed date, year int, month int, day int, count bigint, bot int);</sql>
        <sql>create index resource_access_day_agg_idx1 on resource_access_day_agg_2  (resource_id, year,month,day);</sql>
        <sql>insert into resource_access_day_agg_2 (resource_id, date_accessed, year,month,day, "count" , bot)  select resource_id, date_accessed, year, month, date_part('day',date_accessed), "count", bot from resource_access_day_agg;</sql>

        <sql>create temporary table tmp (id bigserial, total bigint, total_bot bigint, resource_id bigint, day int, month int, year int);</sql>
        <sql>create index resource_access_day_agg_idx12 on tmp  (resource_id, year,month,day);</sql>
        <sql>insert into tmp (total,  total_bot, resource_id, day, month, year)  select
    (select sum(count) from resource_access_day_agg_2 where resource_id=a.resource_id  and a.month=month and a.year=year and a.day=day  ),
    (select sum(bot) from resource_access_day_agg_2 where resource_id=a.resource_id  and a.month=month and a.year=year and a.day=day  ),
     resource_id,  day, month, year from resource_access_day_agg_2 a group by resource_id, year, month, day;</sql>
        
        
        <createTable tableName="resource_access_month_agg">
            <column name="id" type="bigserial" />
            <column name="resource_id" type="bigint" />
            <column name="year" type="int" />
            <column name="month" type="int" />
            <column name="d1" type="int" />
            <column name="d1_bot" type="int" />

            <column name="d2" type="int" />
            <column name="d2_bot" type="int" />
            <column name="d3" type="int" />
            <column name="d3_bot" type="int" />
            <column name="d4" type="int" />
            <column name="d4_bot" type="int" />
            <column name="d5" type="int" />
            <column name="d5_bot" type="int" />
            <column name="d6" type="int" />
            <column name="d6_bot" type="int" />
            <column name="d7" type="int" />
            <column name="d7_bot" type="int" />
            <column name="d8" type="int" />
            <column name="d8_bot" type="int" />
            <column name="d9" type="int" />
            <column name="d9_bot" type="int" />
            <column name="d10" type="int" />
            <column name="d10_bot" type="int" />
            <column name="d11" type="int" />
            <column name="d11_bot" type="int" />
            <column name="d12" type="int" />
            <column name="d12_bot" type="int" />
            <column name="d13" type="int" />
            <column name="d13_bot" type="int" />
            <column name="d14" type="int" />
            <column name="d14_bot" type="int" />
            <column name="d15" type="int" />
            <column name="d15_bot" type="int" />
            <column name="d16" type="int" />
            <column name="d16_bot" type="int" />
            <column name="d17" type="int" />
            <column name="d17_bot" type="int" />
            <column name="d18" type="int" />
            <column name="d18_bot" type="int" />
            <column name="d19" type="int" />
            <column name="d19_bot" type="int" />
            <column name="d20" type="int" />
            <column name="d20_bot" type="int" />
            <column name="d21" type="int" />
            <column name="d21_bot" type="int" />
            <column name="d22" type="int" />
            <column name="d22_bot" type="int" />
            <column name="d23" type="int" />
            <column name="d23_bot" type="int" />
            <column name="d24" type="int" />
            <column name="d24_bot" type="int" />
            <column name="d25" type="int" />
            <column name="d25_bot" type="int" />
            <column name="d26" type="int" />
            <column name="d26_bot" type="int" />
            <column name="d27" type="int" />
            <column name="d27_bot" type="int" />
            <column name="d28" type="int" />
            <column name="d28_bot" type="int" />
            <column name="d29" type="int" />
            <column name="d29_bot" type="int" />
            <column name="d30" type="int" />
            <column name="d30_bot" type="int" />
            <column name="d31" type="int" />
            <column name="d31_bot" type="int" />
        </createTable>
        <createIndex tableName="resource_access_month_agg" indexName="resource_access_month_agg_idx">
            <column name="resource_id"/>
            <column name="year"/>
            <column name="month"/>
        </createIndex>
        <sql>
        insert into resource_access_month_agg (resource_id, year, month, d1 , d2 , d3 , d4 , d5 , d6 , d7 , d8 , d9 , d10 , d11 , d12 , d13 , d14 , d15 , d16 , d17 , d18 , d19 , d20 , d21 , d22 , d23 , d24 , d25 , d26 , d27 , d28 , d29 , d30 , d31, d1_bot,  d2_bot,  d3_bot,  d4_bot,  d5_bot,  d6_bot,  d7_bot,  d8_bot,  d9_bot,  d10_bot,  d11_bot,  d12_bot,  d13_bot,  d14_bot,  d15_bot,  d16_bot,  d17_bot,  d18_bot,  d19_bot,  d20_bot,  d21_bot,  d22_bot,  d23_bot,  d24_bot,  d25_bot,  d26_bot,  d27_bot,  d28_bot,  d29_bot,  d30_bot,  d31_bot )
select resource_id, year, month, 
     (select total from tmp where resource_id=a.resource_id and day=1 and a.month=month and a.year=year ),
     (select total from tmp where resource_id=a.resource_id and day=2 and a.month=month and a.year=year ),
     (select total from tmp where resource_id=a.resource_id and day=3 and a.month=month and a.year=year ),
     (select total from tmp where resource_id=a.resource_id and day=4 and a.month=month and a.year=year ),
     (select total from tmp where resource_id=a.resource_id and day=5 and a.month=month and a.year=year ),
     (select total from tmp where resource_id=a.resource_id and day=6 and a.month=month and a.year=year ),
     (select total from tmp where resource_id=a.resource_id and day=7 and a.month=month and a.year=year ),
     (select total from tmp where resource_id=a.resource_id and day=8 and a.month=month and a.year=year ),
     (select total from tmp where resource_id=a.resource_id and day=9 and a.month=month and a.year=year ),
     (select total from tmp where resource_id=a.resource_id and day=10 and a.month=month and a.year=year ),
     (select total from tmp where resource_id=a.resource_id and day=11 and a.month=month and a.year=year ),
     (select total from tmp where resource_id=a.resource_id and day=12 and a.month=month and a.year=year ),
     (select total from tmp where resource_id=a.resource_id and day=13 and a.month=month and a.year=year ),
     (select total from tmp where resource_id=a.resource_id and day=14 and a.month=month and a.year=year ),
     (select total from tmp where resource_id=a.resource_id and day=15 and a.month=month and a.year=year ),
     (select total from tmp where resource_id=a.resource_id and day=16 and a.month=month and a.year=year ),
     (select total from tmp where resource_id=a.resource_id and day=17 and a.month=month and a.year=year ),
     (select total from tmp where resource_id=a.resource_id and day=18 and a.month=month and a.year=year ),
     (select total from tmp where resource_id=a.resource_id and day=19 and a.month=month and a.year=year ),
     (select total from tmp where resource_id=a.resource_id and day=20 and a.month=month and a.year=year ),
     (select total from tmp where resource_id=a.resource_id and day=21 and a.month=month and a.year=year ),
     (select total from tmp where resource_id=a.resource_id and day=22 and a.month=month and a.year=year ),
     (select total from tmp where resource_id=a.resource_id and day=23 and a.month=month and a.year=year ),
     (select total from tmp where resource_id=a.resource_id and day=24 and a.month=month and a.year=year ),
     (select total from tmp where resource_id=a.resource_id and day=25 and a.month=month and a.year=year ),
     (select total from tmp where resource_id=a.resource_id and day=26 and a.month=month and a.year=year ),
     (select total from tmp where resource_id=a.resource_id and day=27 and a.month=month and a.year=year ),
     (select total from tmp where resource_id=a.resource_id and day=28 and a.month=month and a.year=year ),
     (select total from tmp where resource_id=a.resource_id and day=29 and a.month=month and a.year=year ),
     (select total from tmp where resource_id=a.resource_id and day=30 and a.month=month and a.year=year ),
     (select total from tmp where resource_id=a.resource_id and day=31 and a.month=month and a.year=year ),
     (select total_bot from tmp where resource_id=a.resource_id and day=1 and a.month=month and a.year=year ),
     (select total_bot from tmp where resource_id=a.resource_id and day=2 and a.month=month and a.year=year ),
     (select total_bot from tmp where resource_id=a.resource_id and day=3 and a.month=month and a.year=year ),
     (select total_bot from tmp where resource_id=a.resource_id and day=4 and a.month=month and a.year=year ),
     (select total_bot from tmp where resource_id=a.resource_id and day=5 and a.month=month and a.year=year ),
     (select total_bot from tmp where resource_id=a.resource_id and day=6 and a.month=month and a.year=year ),
     (select total_bot from tmp where resource_id=a.resource_id and day=7 and a.month=month and a.year=year ),
     (select total_bot from tmp where resource_id=a.resource_id and day=8 and a.month=month and a.year=year ),
     (select total_bot from tmp where resource_id=a.resource_id and day=9 and a.month=month and a.year=year ),
     (select total_bot from tmp where resource_id=a.resource_id and day=10 and a.month=month and a.year=year ),
     (select total_bot from tmp where resource_id=a.resource_id and day=11 and a.month=month and a.year=year ),
     (select total_bot from tmp where resource_id=a.resource_id and day=12 and a.month=month and a.year=year ),
     (select total_bot from tmp where resource_id=a.resource_id and day=13 and a.month=month and a.year=year ),
     (select total_bot from tmp where resource_id=a.resource_id and day=14 and a.month=month and a.year=year ),
     (select total_bot from tmp where resource_id=a.resource_id and day=15 and a.month=month and a.year=year ),
     (select total_bot from tmp where resource_id=a.resource_id and day=16 and a.month=month and a.year=year ),
     (select total_bot from tmp where resource_id=a.resource_id and day=17 and a.month=month and a.year=year ),
     (select total_bot from tmp where resource_id=a.resource_id and day=18 and a.month=month and a.year=year ),
     (select total_bot from tmp where resource_id=a.resource_id and day=19 and a.month=month and a.year=year ),
     (select total_bot from tmp where resource_id=a.resource_id and day=20 and a.month=month and a.year=year ),
     (select total_bot from tmp where resource_id=a.resource_id and day=21 and a.month=month and a.year=year ),
     (select total_bot from tmp where resource_id=a.resource_id and day=22 and a.month=month and a.year=year ),
     (select total_bot from tmp where resource_id=a.resource_id and day=23 and a.month=month and a.year=year ),
     (select total_bot from tmp where resource_id=a.resource_id and day=24 and a.month=month and a.year=year ),
     (select total_bot from tmp where resource_id=a.resource_id and day=25 and a.month=month and a.year=year ),
     (select total_bot from tmp where resource_id=a.resource_id and day=26 and a.month=month and a.year=year ),
     (select total_bot from tmp where resource_id=a.resource_id and day=27 and a.month=month and a.year=year ),
     (select total_bot from tmp where resource_id=a.resource_id and day=28 and a.month=month and a.year=year ),
     (select total_bot from tmp where resource_id=a.resource_id and day=29 and a.month=month and a.year=year ),
     (select total_bot from tmp where resource_id=a.resource_id and day=30 and a.month=month and a.year=year ),
     (select total_bot from tmp where resource_id=a.resource_id and day=31 and a.month=month and a.year=year )
     from tmp a  group by resource_id, year, month;
        </sql>
    </changeSet>

    <changeSet id="obsidian-25" author="abrin">
        <addColumn tableName="resource_access_day_agg">
            <column name="day" type='int' />
        </addColumn>
    </changeSet>
    <changeSet id="obsidian-26" author="abrin">
        <dropUniqueConstraint tableName="institution" constraintName="uk_9grdn54hea5ns8ahq4yogpb7u"/>
    </changeSet>
    
</databaseChangeLog>